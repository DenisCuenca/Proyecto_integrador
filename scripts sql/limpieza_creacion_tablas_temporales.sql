-- Universidad T√©cnica Particular de Loja
-- Ingenier√≠a en Ciencias de la Computaci√≥n
-- Materia: Fundamentos de Base de Datos - Octubre 2021 - Febrero 2022
-- Proyecto Final - Ciclo de vida de bases de datos relacionales normalizada
-- Estudiante: Denis Alexander Cuenca Buele | dacuenca7@utpl.edu.ec
-- Link del proyecto en Github: https://github.com/DenisCuenca/Proyecto_integrador.git
-- Profesor: Nelson Piedra | http://investigacion.utpl.edu.ec/nopiedra
-- Fecha: Loja, 8 de febrero del 2022


-- Creaci√≥n de limpieza y creaci√≥n de datos temporales:



-- Se borra si existe una version previa del procedimiento:
DROP TABLE IF EXISTS movie_dataset_cleaned;
-- Creacion de la tabla temporal:

CREATE TABLE movie_dataset_cleaned AS
SELECT

     -- Se almacena los valores a implementar en la tabla.
	`index`, budget, genres, homepage, id, keywords, original_language, original_title, overview, popularity,
	 production_companies, production_countries, release_date, revenue, runtime, spoken_languages, `status`,
	 tagline, title, vote_average, vote_count,CONVERT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE
	                (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE
	                            (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE
	                                (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                                    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                                        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                                            REPLACE(REPLACE(cast,'\\u00e1','√°'),'\\u00e5','√•'),'\\u00e9','√©'),
           '\\u00eb','√´'),'\\u00ed','√≠'),'\\u00e0','√†'), '\\u00f1','√±'),'\\u00f8','√∏'),'\\u042','B'),
           '\\u0438','N'),'\\u044f','—è'),'\\u0421','C'), '\\u043d','H'),'\\u0440','p'),'\\u0433','r'),
           '\\u044c','b'),'\\u067e','Ÿæ'),'\\u06cc','€å'), '\\u0645','ŸÖ'),'\\u0627','ÿß'),'\\u0646','ŸÜ'),
           '\\u0646','ÿπ'),'\\u062f','ÿØ'),'\\u00e8','√®'), '\\u00f3','√≥'),'\\u0160','≈†'),'\\u0107','ƒá'),
           '\\u0107','ƒá'),'\\u00f6','√∂'),'\\u00e4','√§'), '\\u00e4','√¥'),'\\u00e4','√ß'),'\\u0144','≈Ñ'),
           '\\u2019','‚Äô'),'\\u00fc','√º'),'\\u00c1','√Å'), '\\u00ea','√™'),'\\u00ea','√™'),'\\u00e7','√ß'),
           '\\u00dc','√ú'),'\\u0159','≈ô'),'\\u00d8','√ò'), '\\u00fa','√∫'),'\\u010d','ƒç'),'\\u010d','ƒç'),
           '\\u00f0','√∞'),'\\u0219','»ô'),'\\u00d3','√ì'), '\\u0110','ƒê'),'\\u0161','≈°'),'\\u0101','ƒÅ'),
           '\\u00c5','√Ö'),'\\u043b','–ª'),'\\u014c','≈å'), '\\u016b','≈´'),'\\u014d','≈ç'),'\\u015b','≈õ'),
           '\\u00ef','√Ø'),'\\u021b','»õ'),'\\u00c9b','‡≤õ'), '\\u00f4','√¥'),'\\u0301','¬¥'),'\\u00fb','√ª'),
           '\\u00fb','√ª'),'\\u1ed7','·ªó'),'\\u1ecb','·ªã'), '\\u1ea3','·∫£'),'\\u1ebf','·∫ø'),'\\u015f','≈ü'),
           '\\u015ea','D'),'\\u017e','≈æ'),'\\u00c0','√Ä'), '\\u0131','ƒ±'),'\\u011f','ƒü'),'\\u1ec1','·ªÅ'),
           '\\u0639','ÿπ'),'\\u00ee','√Æÿπ'),'\\u00e6','√¶'), '\\u00c9','√â'),'\\u00df','√ü'),'\\u015ea','·ó™')using utf8mb4) AS cast, 
     -- Se remplazan los caracteres erroneos existentes en las tablas
	CONVERT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE
	    (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE
	        (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	            REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE
	                (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                        REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(crew,'\\\\', '\\'),
	        """", "'"),
	 		"', '", """, """),
	 		"': '", """: """),
	 		"': ", """: "),
	 		", '", ", """),
	 		"{'", "{"""), "\\t", ""),
	        '\\u00e9', '√©'),'\\u00e1', '√°'),'\\u00f1', '√±'),'\\u00c9', '√â'),
	        '\\u0159','≈ô'),'\\u00f4', '√¥'),'\\u00f3','√≥'),'\\u00ed','√≠'),
            '\\u00d8','√ò'),'\\u00f8','√∏'),'\\u00c5','√Ö'),'\\u00f6','√∂'),
            '\\u0142','…´'),'\\u017','≈æ'),'\\u0161','≈°'),'\\u00e8','√®'),
	        '\\u0144','≈Ñ'),'\\u00e7','√ß'),'\\u00ef','√Ø'),'\\u0160','≈†'),
	        '\\u00fc','√º'),'\\u00d3','√ì'),'\\u00fd','√Ω'),'\\u00cf','√Ø'),
            '\\u00e3','√£'),'\\u00ee','√Æ'),'\\u00e2','√¢'),'\\u00e4','√§'),
            '\\u00e5','√•'),'\\u00eb','√´'),'\\u00eb','√´'),'\\u00fa','√∫'),
            '\\u00df','√æ'),'\\u00f0','√∞'),'\\u00c1','√Å'),'\\u0107','ƒá'),
            '\\u015','ìçÉ'),'\\u0165','≈•'),'\\u00ea','√™'),'\\u014c','≈å'),
            '\\u00c0','√Ä'),'\\u2019','‚Äô'),'\\u00fb','√ª'),'\\u00e6','√¶'),
            '\\u00fe','√æ'),'\\u0141','≈Å '),'\\u0411','–ë'),'\\u043e','o'),
            '\\u0440','p'),'\\u0438','–∏'),'\\u0441','—Å'),'\\u0421','C'),
            '\\u0443','y'),'\\u0442','T'),'\\u0430','a'),'\\u0446','—Ü'),
            '\\u043a','k'),'\\u0439','–π'),'\\u010d','ƒç'),'\\u5f20','Âº† '),
            '\\u7acb','Á´ã'),'\\u00d6','√ñ'),'\\u0441','—Å'),'\\u010c','ƒå'),
            '\\u00cd','√ç'),'\\u00f5','√µ'),'\\u00e0','√†'),'\\u00f2','√≤'),
            '\\u00d4','√î'),'\\u011b','ƒõ'),'\\u00de','√û'),'\\u00ec','√¨'),
            '\\u00da','√ö'),'\\u010e','ƒé'),'\\u0433','r'),
	         """'", """"), "'""", """")using utf8mb4) AS Crew,
       CONVERT(REPLACE(REPLACE(REPLACE(REPLACE
	                (REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(
	                    REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(director,
           '\\u00e1','√°'),'\\u00e4','√§'),'\\u00f3','√≥'),
           '\\u00e9','√©'),'\\u00d8','√ò'),'\\u00ed','√≠'),
           '\\u00e8','√®'),'\\u00e7','√ß'),'\\u00f4','√¥'),
           '\\u0159','≈ô'),'\\u00f8','√∏'),'\\u00c5','√Ö'),
           '\\u00f6','√∂'),'\\u00e5','√•'),'\\u00ef','√Ø'),
           '\\u00e6','√¶'),'\\u00fb','√ª'),'\\u00c0','√Ä'),
           '\\u00c1','√Å'),'\\u00c9','√â'),'\\u014c','≈å'),
           '\\u0161','≈°'),'\\u0142','…´'),'\\u0144','≈Ñ'),
           '\\u017','≈æ'),'\\u00f1','√±')using utf8mb4) AS director
		FROM movie_dataset;


-- se elimina una version previa de la tabla
DROP PROCEDURE IF EXISTS Jsons ;
DELIMITER //
CREATE PROCEDURE Jsons()
BEGIN
     -- ciclo repetitivo para ir cargando datos desde el arreglo JSON hacia la tabla temporal
	DECLARE a INT Default 0 ;
     -- Se eliminan y crean tablas temporales para almacenar los datos:
	DROP TABLE IF EXISTS tmp_production_companies ;
	CREATE TABlE tmp_production_companies (id_movie INT, id_production_company INT, name_production_company VARCHAR (100) );
	DROP TABLE IF EXISTS tmp_production_countries ;
	CREATE TABlE tmp_production_countries (id_movie INT, iso_3166_1 VARCHAR (7), country VARCHAR (100) );
	DROP TABLE IF EXISTS tmp_spoken_languages;
	CREATE TABlE tmp_spoken_languages (id_movie INT, iso_639_1 VARCHAR (5), `language` VARCHAR (100) );
	DROP TABLE IF EXISTS tmp_crew ;
	CREATE TABlE tmp_crew(id_movie INT, id_crew INT, job VARCHAR (200), name VARCHAR (400), gender INT, credit_id VARCHAR (50), department VARCHAR (50) );
	DROP TABLE IF EXISTS tmp_genres;
	CREATE TABLE tmp_genres (id_movie INT,genre VARCHAR(100));
	DROP TABLE IF EXISTS tmp_cast;
	CREATE TABLE tmp_cast(id_movie INT, cast VARCHAR(100));
	DROP TABLE IF EXISTS tmp_movie_keyword;
	CREATE TABLE tmp_movie_keyword(id_movie INT, keyword VARCHAR(100));

-- inicio del loop
  simple_loop: LOOP
          -- Se insertan los datos en formato json en las tablas temporales:
		INSERT INTO tmp_production_companies (id_movie, id_production_company, name_production_company)
		SELECT id as id_Movie,
               
			JSON_EXTRACT(CONVERT(production_companies using utf8mb4), CONCAT("$[",a,"].id")) AS id_production_company,
			JSON_EXTRACT(CONVERT(production_companies using utf8mb4), CONCAT("$[",a,"].name")) AS id_production_company
		FROM movie_dataset m ;
		INSERT INTO tmp_production_countries (id_movie, iso_3166_1, country)
		SELECT id,
			JSON_EXTRACT(production_countries, CONCAT('$[',a,'].iso_3166_1')) AS iso_3166_1,
			JSON_EXTRACT(production_countries , CONCAT('$[',a,'].name')) AS country
		FROM movie_dataset m ;
		INSERT INTO tmp_spoken_languages (id_movie, iso_639_1, `language`)
		SELECT id,
			JSON_EXTRACT(spoken_languages , CONCAT('$[',a,'].iso_639_1')) AS iso_639_1,
			JSON_EXTRACT(spoken_languages , CONCAT('$[',a,'].name')) AS language
		FROM movie_dataset m ;
		INSERT INTO tmp_crew (id_movie, id_crew, job, name, gender, credit_id, department)
		SELECT id as id_Movie,
			JSON_EXTRACT(CONVERT(crew using utf8mb4), CONCAT("$[",a,"].id")) AS id_crew,
			JSON_EXTRACT(CONVERT(crew using utf8mb4), CONCAT("$[",a,"].job")) AS job,
			JSON_EXTRACT(CONVERT(crew using utf8mb4), CONCAT("$[",a,"].name")) AS name,
			JSON_EXTRACT(CONVERT(crew using utf8mb4), CONCAT("$[",a,"].gender")) AS gender,
			JSON_EXTRACT(CONVERT(crew using utf8mb4), CONCAT("$[",a,"].credit_id")) AS credit_id,
			JSON_EXTRACT(CONVERT(crew using utf8mb4), CONCAT("$[",a,"].department")) AS department
		FROM movie_dataset_cleaned m;
		INSERT INTO tmp_genres (id_movie, genre)
        SELECT * FROM (
			SELECT id as id_Movie,
				REPLACE(JSON_EXTRACT(CONCAT('["', REPLACE(REPLACE (genres, ' ', '","'), 'Science","Fiction', 'Science Fiction'), '"]'),
				    CONCAT("$[",a,"]")), """","") AS genre
			FROM movie_dataset_cleaned) t
        WHERE genre != "";
		INSERT INTO tmp_cast(id_movie, cast)
		SELECT id,
          -- Se implementa una estructura condicional que nos permita conocer la longitu y espacios en blanco es¬øxistentes en cada tabla.
        REPLACE(JSON_EXTRACT(
		CONCAT ('["',
	   			IF(SpacesNumber >= 13, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(cast, ' ', -14), ' ', 2), '","'), '') ,
	   			IF(SpacesNumber >= 11, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(cast, ' ', -12), ' ', 2), '","'), '') ,
	   			IF(SpacesNumber >= 9, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(cast, ' ', -10), ' ', 2), '","'), '') ,
	   			IF(SpacesNumber >= 7, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(cast, ' ', -8), ' ', 2), '","'), '') ,
	   			IF(SpacesNumber >= 5, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(cast, ' ', -6), ' ', 2), '","'), '') ,
	   			IF(SpacesNumber >=3, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(cast, ' ', -4), ' ', 2), '","'), '') ,
        		IF(SpacesNumber >=1, CONCAT(SUBSTRING_INDEX(cast, ' ', -2), '"'), ''),
        ']'), CONCAT("$[",a,"]")),
        "=", "") AS CastJSon
		FROM (
		SELECT id, cast, LENGTH(cast) - LENGTH(REPLACE(cast, ' ', '')) AS SpacesNumber FROM (
		SELECT id,
		REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(cast, '"',''),' Jr.', '=Jr.'), ' Jr ', '=Jr '), '. ', '.='),
	    	' The ', ' The='), ' the ', ' the='), 'the=Cable Guy', 'the=Cable=Guy' ), 'Tupac Amaru Shakur', 'Tupac Amaru=Shakur')  AS cast
		FROM movie_dataset WHERE Cast <> '') t1) t2;

		INSERT INTO tmp_movie_keyword
            SELECT id,
          -- Se implementa una estructura condicional que nos permita conocer la longitu y espacios en blanco es¬øxistentes en cada tabla.
                REPLACE(JSON_EXTRACT(REPLACE(
                    CONCAT('["',
                        IF(SpacesNumber >= 13, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(keywords, ' ', -14), ' ', 2), '","'), '') ,
	   			        IF(SpacesNumber >= 11, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(keywords, ' ', -12), ' ', 2), '","'), '') ,
	   			        IF(SpacesNumber >= 9, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(keywords, ' ', -10), ' ', 2), '","'), '') ,
	   			        IF(SpacesNumber >= 7, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(keywords, ' ', -8), ' ', 2), '","'), '') ,
	   			        IF(SpacesNumber >= 5, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(keywords, ' ', -6), ' ', 2), '","'), '') ,
	   			        IF(SpacesNumber >=3, CONCAT(SUBSTRING_INDEX(SUBSTRING_INDEX(keywords, ' ', -4), ' ', 2), '","'), '') ,
        		        IF(SpacesNumber >=1, CONCAT(SUBSTRING_INDEX(keywords, ' ', -2), '"'), ''),
                ']'),'["]','[]'), CONCAT("$[",a,"]")),
                "=", "") AS keywordJson
            FROM(
                Select id, keywords, LENGTH(keywords) - LENGTH(REPLACE(keywords, ' ', '')) AS SpacesNumber FROM (
                SELECT id,
                REPLACE(REPLACE(keywords, '"',''), 'marvel comic', 'marvel=comic') AS keywords
                FROM movie_dataset WHERE keywords <> '') t1) t2;
			SET a=a+1;
     	IF a=10 THEN
            LEAVE simple_loop;
      END IF;
   END LOOP simple_loop;

     -- se limpial los valores nulos en caso de exisir
    DELETE FROM tmp_production_companies WHERE id_production_company IS NULL ;
	DELETE FROM tmp_production_countries WHERE iso_3166_1 IS NULL ;
	DELETE FROM tmp_spoken_languages WHERE iso_639_1 IS NULL ;
    DELETE FROM tmp_crew WHERE id_crew IS NULL ;
	DELETE FROM tmp_genres WHERE genre IS NULL;
	DELETE FROM tmp_cast WHERE cast is NULL;
	DELETE FROM tmp_movie_keyword WHERE keyword IS NULL;
END //
DELIMITER ;
Call Jsons();


-- Se eliminal las tablas temporales, una vez creadas las tablas definitivas.
DROP TABLE IF EXISTS tmp_cast;
DROP TABLE IF EXISTS tmp_genres;
DROP TABLE IF EXISTS tmp_production_countries;
DROP TABLE IF EXISTS tmp_production_companies;
DROP TABLE IF EXISTS tmp_spoken_languages;
DROP TABLE IF EXISTS tmp_crew;
DROP TABLE IF EXISTS movie_dataset_cleaned;
DROP TABLE IF EXISTS tmp_spoken_languages;
DROP TABLE IF EXISTS tmp_movie_keyword;
